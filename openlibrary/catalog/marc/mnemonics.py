# read MARC mnemonics
# result is in MARC8 and still needs to be converted to Unicode

import re

re_brace = re.compile('(\{.+?\})', re.U)

mapping = {
 '{00}': '\x00',
 '{01}': '\x01',
 '{02}': '\x02',
 '{03}': '\x03',
 '{04}': '\x04',
 '{05}': '\x05',
 '{06}': '\x06',
 '{07}': '\x07',
 '{08}': '\x08',
 '{09}': '\t',
 '{0A}': '\n',
 '{0B}': '\x0b',
 '{0C}': '\x0c',
 '{0D}': '\r',
 '{0E}': '\x0e',
 '{0F}': '\x0f',
 '{0}': '0',
 '{10}': '\x10',
 '{11}': '\x11',
 '{12}': '\x12',
 '{13}': '\x13',
 '{14}': '\x14',
 '{15}': '\x15',
 '{16}': '\x16',
 '{17}': '\x17',
 '{18}': '\x18',
 '{19}': '\x19',
 '{1A}': '\x1a',
 '{1B}': '\x1b',
 '{1C}': '\x1c',
 '{1D}': '\x1d',
 '{1E}': '\x1e',
 '{1F}': '\x1f',
 '{1}': '1',
 '{20}': ' ',
 '{21}': '!',
 '{22}': '"',
 '{23}': '#',
 '{24}': '$',
 '{25}': '%',
 '{26}': '&',
 '{27}': "'",
 '{28}': '(',
 '{29}': ')',
 '{2A}': '*',
 '{2B}': '+',
 '{2C}': ',',
 '{2D}': '-',
 '{2E}': '.',
 '{2F}': '/',
 '{2}': '2',
 '{30}': '0',
 '{31}': '1',
 '{32}': '2',
 '{33}': '3',
 '{34}': '4',
 '{35}': '5',
 '{36}': '6',
 '{37}': '7',
 '{38}': '8',
 '{39}': '9',
 '{3A}': ':',
 '{3B}': ';',
 '{3C}': '<',
 '{3D}': '=',
 '{3E}': '>',
 '{3F}': '?',
 '{3}': '3',
 '{40}': '@',
 '{41}': 'A',
 '{42}': 'B',
 '{43}': 'C',
 '{44}': 'D',
 '{45}': 'E',
 '{46}': 'F',
 '{47}': 'G',
 '{48}': 'H',
 '{49}': 'I',
 '{4A}': 'J',
 '{4B}': 'K',
 '{4C}': 'L',
 '{4D}': 'M',
 '{4E}': 'N',
 '{4F}': 'O',
 '{4}': '4',
 '{50}': 'P',
 '{51}': 'Q',
 '{52}': 'R',
 '{53}': 'S',
 '{54}': 'T',
 '{55}': 'U',
 '{56}': 'V',
 '{57}': 'W',
 '{58}': 'X',
 '{59}': 'Y',
 '{5A}': 'Z',
 '{5B}': '[',
 '{5C}': '\\',
 '{5D}': ']',
 '{5E}': '^',
 '{5F}': '_',
 '{5}': '5',
 '{60}': '`',
 '{61}': 'a',
 '{62}': 'b',
 '{63}': 'c',
 '{64}': 'd',
 '{65}': 'e',
 '{66}': 'f',
 '{67}': 'g',
 '{68}': 'h',
 '{69}': 'i',
 '{6A}': 'j',
 '{6B}': 'k',
 '{6C}': 'l',
 '{6D}': 'm',
 '{6E}': 'n',
 '{6F}': 'o',
 '{6}': '6',
 '{70}': 'p',
 '{71}': 'q',
 '{72}': 'r',
 '{73}': 's',
 '{74}': 't',
 '{75}': 'u',
 '{76}': 'v',
 '{77}': 'w',
 '{78}': 'x',
 '{79}': 'y',
 '{7A}': 'z',
 '{7B}': '{',
 '{7C}': '|',
 '{7D}': '}',
 '{7E}': '~',
 '{7F}': '\x7f',
 '{7}': '7',
 '{80}': '\x80',
 '{81}': '\x81',
 '{82}': '\x82',
 '{83}': '\x83',
 '{84}': '\x84',
 '{85}': '\x85',
 '{86}': '\x86',
 '{87}': '\x87',
 '{88}': '\x88',
 '{89}': '\x89',
 '{8A}': '\x8a',
 '{8B}': '\x8b',
 '{8C}': '\x8c',
 '{8D}': '\x8d',
 '{8E}': '\x8e',
 '{8F}': '\x8f',
 '{8}': '8',
 '{90}': '\x90',
 '{91}': '\x91',
 '{92}': '\x92',
 '{93}': '\x93',
 '{94}': '\x94',
 '{95}': '\x95',
 '{96}': '\x96',
 '{97}': '\x97',
 '{98}': '\x98',
 '{99}': '\x99',
 '{9A}': '\x9a',
 '{9B}': '\x9b',
 '{9C}': '\x9c',
 '{9D}': '\x9d',
 '{9E}': '\x9e',
 '{9F}': '\x9f',
 '{9}': '9',
 '{A0}': '\xa0',
 '{A1}': '\xa1',
 '{A2}': '\xa2',
 '{A3}': '\xa3',
 '{A4}': '\xa4',
 '{A5}': '\xa5',
 '{A6}': '\xa6',
 '{A7}': '\xa7',
 '{A8}': '\xa8',
 '{A9}': '\xa9',
 '{AA}': '\xaa',
 '{AB}': '\xab',
 '{AC}': '\xac',
 '{AD}': '\xad',
 '{AElig}': '\xa5',
 '{AE}': '\xae',
 '{AF}': '\xaf',
 '{Aacute}': '\xe2A',
 '{Abreve}': '\xe6A',
 '{Acirc}': '\xe3A',
 '{Acy}': 'A',
 '{Agrave}': '\xe1A',
 '{Aogon}': '\xf1A',
 '{Aring}': '\xeaA',
 '{Atilde}': '\xe4A',
 '{Auml}': '\xe8A',
 '{A}': 'A',
 '{B0}': '\xb0',
 '{B1}': '\xb1',
 '{B2}': '\xb2',
 '{B3}': '\xb3',
 '{B4}': '\xb4',
 '{B5}': '\xb5',
 '{B6}': '\xb6',
 '{B7}': '\xb7',
 '{B8}': '\xb8',
 '{B9}': '\xb9',
 '{BA}': '\xba',
 '{BB}': '\xbb',
 '{BC}': '\xbc',
 '{BD}': '\xbd',
 '{BE}': '\xbe',
 '{BF}': '\xbf',
 '{Bcy}': 'B',
 '{B}': 'B',
 '{C0}': '\xc0',
 '{C1}': '\xc1',
 '{C2}': '\xc2',
 '{C3}': '\xc3',
 '{C4}': '\xc4',
 '{C5}': '\xc5',
 '{C6}': '\xc6',
 '{C7}': '\xc7',
 '{C8}': '\xc8',
 '{C9}': '\xc9',
 '{CA}': '\xca',
 '{CB}': '\xcb',
 '{CC}': '\xcc',
 '{CD}': '\xcd',
 '{CE}': '\xce',
 '{CF}': '\xcf',
 '{CHcy}': 'Ch',
 '{Cacute}': '\xe2C',
 '{Ccaron}': '\xe9C',
 '{Ccedil}': '\xf0C',
 '{C}': 'C',
 '{D0}': '\xd0',
 '{D1}': '\xd1',
 '{D2}': '\xd2',
 '{D3}': '\xd3',
 '{D4}': '\xd4',
 '{D5}': '\xd5',
 '{D6}': '\xd6',
 '{D7}': '\xd7',
 '{D8}': '\xd8',
 '{D9}': '\xd9',
 '{DA}': '\xda',
 '{DB}': '\xdb',
 '{DC}': '\xdc',
 '{DD}': '\xdd',
 '{DE}': '\xde',
 '{DF}': '\xdf',
 '{DJEcy}': '\xa3',
 '{DZEcy}': 'Dz',
 '{DZHEcy}': 'D\xe9z',
 '{Dagger}': '|',
 '{Dcaron}': '\xe9D',
 '{Dcy}': 'D',
 '{Dstrok}': '\xa3',
 '{D}': 'D',
 '{E0}': '\xe0',
 '{E1}': '\xe1',
 '{E2}': '\xe2',
 '{E3}': '\xe3',
 '{E4}': '\xe4',
 '{E5}': '\xe5',
 '{E6}': '\xe6',
 '{E7}': '\xe7',
 '{E8}': '\xe8',
 '{E9}': '\xe9',
 '{EA}': '\xea',
 '{EB}': '\xeb',
 '{EC}': '\xec',
 '{ED}': '\xed',
 '{EE}': '\xee',
 '{EF}': '\xef',
 '{ETH}': '\xa3',
 '{Eacute}': '\xe2E',
 '{Ecaron}': '\xe9E',
 '{Ecirc}': '\xe3E',
 '{Ecy}': '\xe7E',
 '{Egrave}': '\xe1E',
 '{Ehookr}': '\xf1E',
 '{Eogon}': '\xf1E',
 '{Euml}': '\xe8E',
 '{E}': 'E',
 '{F0}': '\xf0',
 '{F1}': '\xf1',
 '{F2}': '\xf2',
 '{F3}': '\xf3',
 '{F4}': '\xf4',
 '{F5}': '\xf5',
 '{F6}': '\xf6',
 '{F7}': '\xf7',
 '{F8}': '\xf8',
 '{F9}': '\xf9',
 '{FA}': '\xfa',
 '{FB}': '\xfb',
 '{FC}': '\xfc',
 '{FD}': '\xfd',
 '{FE}': '\xfe',
 '{FF}': '\xff',
 '{Fcy}': 'F',
 '{F}': 'F',
 '{GEcy}': 'G',
 '{GHcy}': 'G',
 '{GJEcy}': '\xe2G',
 '{Gcy}': 'G',
 '{G}': 'G',
 '{HARDcy}': '\xb7',
 '{Hcy}': 'H',
 '{H}': 'H',
 '{IEcy}': '\xebI\xecE',
 '{IJlig}': 'IJ',
 '{IOcy}': '\xebI\xecO',
 '{IYcy}': 'Y',
 '{Iacute}': '\xe2I',
 '{Icaron}': '\xe9I',
 '{Icirc}': '\xe3I',
 '{Icy}': 'I',
 '{Idot}': '\xe7I',
 '{Igrave}': '\xe1I',
 '{Iumlcy}': '\xe8I',
 '{Iuml}': '\xe8I',
 '{I}': 'I',
 '{JEcy}': 'J',
 '{JIcy}': '\xe8I',
 '{Jcy}': '\xe6I',
 '{J}': 'J',
 '{KHcy}': 'Kh',
 '{KJEcy}': '\xe2K',
 '{Kcy}': 'K',
 '{K}': 'K',
 '{LJEcy}': 'Lj',
 '{Lacute}': '\xe2L',
 '{Lcy}': 'L',
 '{Lstrok}': '\xa1',
 '{L}': 'L',
 '{Mcy}': 'M',
 '{M}': 'M',
 '{NJEcy}': 'Nj',
 '{Nacute}': '\xe2N',
 '{Ncaron}': '\xe9N',
 '{Ncy}': 'N',
 '{No}': 'No.',
 '{Ntilde}': '\xb4N',
 '{N}': 'N',
 '{OElig}': '\xa6',
 '{Oacute}': '\xe2O',
 '{Ocirc}': '\xe3O',
 '{Ocy}': 'O',
 '{Odblac}': '\xeeO',
 '{Ograve}': '\xe1O',
 '{Ohorn}': '\xac',
 '{Ostrok}': '\xa2',
 '{Otilde}': '\xe4O',
 '{Ouml}': '\xe8O',
 '{O}': 'O',
 '{Pcy}': 'P',
 '{P}': 'P',
 '{Q}': 'Q',
 '{Racute}': '\xe2R',
 '{Rcaron}': '\xe9R',
 '{Rcy}': 'R',
 '{R}': 'R',
 '{SHCHcy}': 'Shch',
 '{SHcy}': 'Sh',
 '{SOFTcy}': '\xa7',
 '{Sacute}': '\xe2S',
 '{Scommab}': '\xf7S',
 '{Scy}': 'S',
 '{S}': 'S',
 '{THORN}': '\xa4',
 '{TSHEcy}': '\xe2C',
 '{TScy}': '\xebT\xecS',
 '{Tcaron}': '\xe9T',
 '{Tcommab}': '\xf7T',
 '{Tcy}': 'T',
 '{T}': 'T',
 '{Uacute}': '\xe2U',
 '{Ubrevecy}': '\xe6U',
 '{Ucirc}': '\xe3U',
 '{Ucy}': 'U',
 '{Udblac}': '\xeeU',
 '{Ugrave}': '\xe1U',
 '{Uhorn}': '\xad',
 '{Uring}': '\xeaU',
 '{Uuml}': '\xe8U',
 '{U}': 'U',
 '{Vcy}': 'V',
 '{V}': 'V',
 '{W}': 'W',
 '{X}': 'X',
 '{YAcy}': '\xebI\xecA',
 '{YEcy}': 'E',
 '{YIcy}': 'I',
 '{YUcy}': '\xebI\xecU',
 '{Yacute}': '\xe2Y',
 '{Ycy}': 'Y',
 '{Y}': 'Y',
 '{ZHcy}': 'Zh',
 '{ZHuacy}': '\xebZ\xech',
 '{Zacute}': '\xe2Z',
 '{Zcy}': 'Z',
 '{Zdot}': '\xe7Z',
 '{Z}': 'Z',
 '{aacute}': '\xe2a',
 '{abreve}': '\xe6a',
 '{acirc}': '\xe3a',
 '{acute}': '\xe2',
 '{acy}': 'a',
 '{aelig}': '\xb5',
 '{agrave}': '\xe1a',
 '{agr}': 'b',
 '{alif}': '\xae',
 '{amp}': '&',
 '{aogon}': '\xf1a',
 '{apos}': "'",
 '{arab}': '(3',
 '{aring}': '\xeaa',
 '{ast}': '*',
 '{asuper}': 'a',
 '{atilde}': '\xe4a',
 '{auml}': '\xe8a',
 '{ayn}': '\xb0',
 '{a}': 'a',
 '{bcy}': 'b',
 '{bgr}': 'c',
 '{breveb}': '\xf9',
 '{breve}': '\xe6',
 '{brvbar}': '|',
 '{bsol}': '\\',
 '{bull}': '*',
 '{b}': 'b',
 '{cacute}': '\xe2c',
 '{candra}': '\xef',
 '{caron}': '\xe9',
 '{ccaron}': '\xe9c',
 '{ccedil}': '\xf0c',
 '{cedil}': '\xf0',
 '{cent}': 'c',
 '{chcy}': 'ch',
 '{circb}': '\xf4',
 '{circ}': '\xe3',
 '{cjk}': '$1',
 '{colon}': ':',
 '{commaa}': '\xfe',
 '{commab}': '\xf7',
 '{commat}': '@',
 '{comma}': ',',
 '{copy}': '\xc3',
 '{curren}': '*',
 '{cyril}': '(N',
 '{c}': 'c',
 '{dagger}': '|',
 '{dblac}': '\xee',
 '{dbldotb}': '\xf3',
 '{dblunder}': '\xf5',
 '{dcaron}': '\xe9d',
 '{dcy}': 'd',
 '{deg}': '\xc0',
 '{diaer}': '\xe8',
 '{divide}': '/',
 '{djecy}': '\xb3',
 '{dollar}': '$',
 '{dotb}': '\xf2',
 '{dot}': '\xe7',
 '{dstrok}': '\xb3',
 '{dzecy}': 'dz',
 '{dzhecy}': 'd\xe9z',
 '{d}': 'd',
 '{eacute}': '\xe2e',
 '{ea}': '\xea',
 '{ecaron}': '\xe9e',
 '{ecirc}': '\xe3e',
 '{ecy}': '\xe7e',
 '{egrave}': '\xe1e',
 '{ehookr}': '\xf1e',
 '{eogon}': '\xf1e',
 '{equals}': '=',
 '{esc}': '\x1b',
 '{eth}': '\xba',
 '{euml}': '\xe8e',
 '{excl}': '!',
 '{e}': 'e',
 '{fcy}': 'f',
 '{flat}': '\xa9',
 '{fnof}': 'f',
 '{frac12}': '1/2',
 '{frac14}': '1/4',
 '{frac34}': '3/4',
 '{f}': 'f',
 '{gcy}': 'g',
 '{gecy}': 'g',
 '{ggr}': 'g',
 '{ghcy}': 'g',
 '{gjecy}': '\xe2g',
 '{grave}': '\xe1',
 '{greek}': 'g',
 '{gs}': '\x1d',
 '{gt}': '>',
 '{g}': 'g',
 '{hardcy}': '\xb7',
 '{hardsign}': '\xb7',
 '{hcy}': 'h',
 '{hebrew}': '(2',
 '{hellip}': '...',
 '{hooka}': '\xe0',
 '{hookl}': '\xf7',
 '{hookr}': '\xf1',
 '{hyphen}': '-',
 '{h}': 'h',
 '{iacute}': '\xe2i',
 '{icaron}': '\xe9i',
 '{icirc}': '\xe3i',
 '{icy}': 'i',
 '{iecy}': '\xebi\xece',
 '{iexcl}': '\xc6',
 '{igrave}': '\xe1i',
 '{ijlig}': 'ij',
 '{inodot}': '\xb8',
 '{iocy}': '\xebi\xeco',
 '{iquest}': '\xc5',
 '{iumlcy}': '\xe8i',
 '{iuml}': '\xe8i',
 '{iycy}': 'y',
 '{i}': 'i',
 '{jcy}': '\xe6i',
 '{jecy}': 'j',
 '{jicy}': '\xe8i',
 '{joiner}': '\x8d',
 '{j}': 'j',
 '{kcy}': 'k',
 '{khcy}': 'kh',
 '{kjecy}': '\xe2k',
 '{k}': 'k',
 '{lacute}': '\xe2l',
 '{laquo}': '"',
 '{latin}': '(B',
 '{lcub}': '{',
 '{lcy}': 'l',
 '{ldbltil}': '\xfa',
 '{ldquo}': '"',
 '{ljecy}': 'lj',
 '{llig}': '\xeb',
 '{lpar}': '(',
 '{lsqb}': '[',
 '{lsquor}': "'",
 '{lsquo}': "'",
 '{lstrok}': '\xb1',
 '{lt}': '<',
 '{l}': 'l',
 '{macr}': '\xe5',
 '{mcy}': 'm',
 '{mdash}': '--',
 '{middot}': '\xa8',
 '{mlPrime}': '\xb7',
 '{mllhring}': '\xb0',
 '{mlprime}': '\xa7',
 '{mlrhring}': '\xae',
 '{m}': 'm',
 '{nacute}': '\xe2n',
 '{ncaron}': '\xe9n',
 '{ncy}': 'n',
 '{ndash}': '--',
 '{njecy}': 'nj',
 '{nonjoin}': '\x8e',
 '{ntilde}': '\xb4n',
 '{num}': '#',
 '{n}': 'n',
 '{oacute}': '\xe2o',
 '{ocirc}': '\xe3o',
 '{ocy}': 'o',
 '{odblac}': '\xeeo',
 '{oelig}': '\xb6',
 '{ogon}': '\xf1',
 '{ograve}': '\xe1o',
 '{ohorn}': '\xbc',
 '{ordf}': 'a',
 '{ordm}': 'o',
 '{ostrok}': '\xb2',
 '{osuper}': 'o',
 '{otilde}': '\xe4o',
 '{ouml}': '\xe8o',
 '{o}': 'o',
 '{para}': '|',
 '{pcy}': 'p',
 '{percnt}': '%',
 '{period}': '.',
 '{phono}': '\xc2',
 '{pipe}': '|',
 '{plusmn}': '\xab',
 '{plus}': '+',
 '{pound}': '\xb9',
 '{p}': 'p',
 '{quest}': '?',
 '{quot}': '"',
 '{q}': 'q',
 '{racute}': '\xe2r',
 '{raquo}': '"',
 '{rcaron}': '\xe9r',
 '{rcedil}': '\xf8',
 '{rcommaa}': '\xed',
 '{rcub}': '}',
 '{rcy}': 'r',
 '{rdbltil}': '\xfb',
 '{rdquofh}': '"',
 '{rdquor}': '"',
 '{reg}': '\xaa',
 '{ringb}': '\xf4',
 '{ring}': '\xea',
 '{rlig}': '\xec',
 '{rpar}': ')',
 '{rsqb}': ']',
 '{rsquor}': "'",
 '{rsquo}': "'",
 '{rs}': '\x1e',
 '{r}': 'r',
 '{sacute}': '\xe2s',
 '{scommab}': '\xf7s',
 '{scriptl}': '\xc1',
 '{scy}': 's',
 '{sect}': '|',
 '{semi}': ';',
 '{sharp}': '\xc4',
 '{shchcy}': 'shch',
 '{shcy}': 'sh',
 '{shy}': '-',
 '{softcy}': '\xa7',
 '{softsign}': '\xa7',
 '{sol}': '/',
 '{space}': ' ',
 '{spcirc}': '^',
 '{spgrave}': '`',
 '{sptilde}': '~',
 '{spundscr}': '_',
 '{squf}': '|',
 '{sub}': 'b',
 '{sup1}': '\x1bp1\x1bs',
 '{sup2}': '\x1bp2\x1bs',
 '{sup3}': '\x1bp3\x1bs',
 '{super}': 'p',
 '{szlig}': 'ss',
 '{s}': 's',
 '{tcaron}': '\xe9t',
 '{tcommab}': '\xf7t',
 '{tcy}': 't',
 '{thorn}': '\xb4',
 '{tilde}': '\xe4',
 '{times}': 'x',
 '{trade}': '(Tm)',
 '{tscy}': '\xebt\xecs',
 '{tshecy}': '\xe2c',
 '{t}': 't',
 '{uacute}': '\xe2u',
 '{ubrevecy}': '\xe6u',
 '{ucirc}': '\xe3u',
 '{ucy}': 'u',
 '{udblac}': '\xeeu',
 '{ugrave}': '\xe1u',
 '{uhorn}': '\xbd',
 '{uml}': '\xe8',
 '{under}': '\xf6',
 '{uring}': '\xeau',
 '{us}': '\x1f',
 '{uuml}': '\xe8u',
 '{u}': 'u',
 '{vcy}': 'v',
 '{verbar}': '|',
 '{vlineb}': '\xf2',
 '{v}': 'v',
 '{w}': 'w',
 '{x}': 'x',
 '{yacute}': '\xe2y',
 '{yacy}': '\xebi\xeca',
 '{ycy}': 'y',
 '{yecy}': 'e',
 '{yen}': 'Y',
 '{yicy}': 'i',
 '{yucy}': '\xebi\xecu',
 '{y}': 'y',
 '{zacute}': '\xe2z',
 '{zcy}': 'z',
 '{zdot}': '\xe7z',
 '{zhcy}': 'zh',
 '{zhuacy}': '\xebz\xech',
 '{z}': 'z'}

def load_table(filename):
    mapping = {}
    for line in (i.split(",") for i in open(filename) if i.startswith("{")):
        key = line[0]
        value = ""
        for d in line[2].strip().split(" "):
            assert len(d) == 4
            assert d[3] == 'd'
            value += chr(int(d[0:3]))

        mapping[key] = value
    return mapping

def test_read():
    input = 'Tha{mllhring}{macr}alib{macr}i, {mllhring}Abd al-Malik ibn Mu{dotb}hammad,'
    output = 'Tha\xb0\xe5alib\xe5i, \xb0Abd al-Malik ibn Mu\xf2hammad,'
    assert read(input) == output
    input = 'El Ing.{eniero} Federico E. Capurro y el nacimiento de la profesi\xe2on bibliotecaria en el Uruguay.'
    assert read(input) == input

def read(input):
    return re_brace.sub(lambda x: mapping.get(x.group(1), x.group(1)), input)
